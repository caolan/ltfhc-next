# everything that is needed for the app to function
---

- hosts: all
  tasks:


    #####
    #
    # From core role in ltfhc-config.
    # Only systemd install steps
    # 
    # From https://github.com/iilab/ltfhc-config/blob/master/playbook/roles/core/tasks/deploy.yml
    #
    #####

    ## Systemd

    - name: Install Systemd for managing docker and job scheduling
      apt: pkg=systemd state=present
      sudo: yes

    # http://regex101.com/r/mO9zX3/1
    - name: Install systemd in Grub
      lineinfile: dest=/etc/default/grub 'regexp=^GRUB_CMDLINE_LINUX=\"((?!.*?init=/bin/systemd).*?)\"$' 'line=GRUB_CMDLINE_LINUX="\1 init=/bin/systemd"' state=present backrefs=yes
      register: updated_grub
      sudo: yes

    - name: Update grub 
      command: update-grub
      when: updated_grub.changed
      sudo: yes

    - name: Restart the server after update grub 
      command: "shutdown -r now"
      when: updated_grub.changed
      sudo: yes

    # from http://stackoverflow.com/questions/22534033/how-can-i-use-ansible-playbook-to-reboot-a-ubuntu-server
    # this bit doesn't work
    # - name: Wait until the virtual machine stop ie. ssh port stop responding
    #  local_action: wait_for host={{ansible_ssh_host}} port={{ansible_ssh_port}} state=stopped
    #  sudo: false

    - name: Wait for server to come up after update grub 
      local_action: wait_for host={{ansible_ssh_host}} port={{ansible_ssh_port}} delay=30
      when: updated_grub.changed
      sudo: false

    - name: Install vim
      apt: pkg=vim state=present
      sudo: yes

    - name: Install screen
      apt: pkg=screen state=present
      sudo: yes

    - name: Default .screenrc
      copy: src=system/.screenrc dest=/home/{{ansible_ssh_user}}/.screenrc owner={{ansible_ssh_user}} group={{ansible_ssh_user}} backup=yes
      sudo: yes

    - name: Default .bash_profile starting screen
      copy: src=system/.bash_profile dest=/home/{{ansible_ssh_user}}/.bash_profile owner={{ansible_ssh_user}} group={{ansible_ssh_user}} backup=yes
      sudo: yes

    #####
    #
    # From base role in ltfhc-config.
    # docker and couch install
    # 
    # From https://github.com/iilab/ltfhc-config/blob/master/playbook/roles/base/tasks/deploy.yml
    #
    #####

    ## Docker

    - name: Check that https transport for apt is enabled
      apt: pkg=apt-transport-https state=present
      sudo: yes

    - name: add the docker repository key
      apt_key: keyserver=hkp://keyserver.ubuntu.com:80 id=0xDF4FD13717AAD7D6 state=present
      sudo: yes

    - name: add the test docker repository - currently the get repository is not working
      apt_repository: repo='deb https://test.docker.io/ubuntu docker main' state=present
      sudo: yes

    - name: remove the get docker repository
      apt_repository: repo='deb https://get.docker.io/ubuntu docker main' state=absent
      sudo: yes

    - name: install docker
      apt: pkg=lxc-docker state=present update_cache=true
      sudo: yes

    - name: Run docker as a service
      service: name=docker enabled=yes state=started
      sudo: yes

    # Install docker-py

    - name: Clone docker-py repository
      git: repo=https://github.com/docker/docker-py.git dest=/opt/docker-py
      sudo: yes

    - name: Install python-setuptools
      apt: pkg=python-setuptools state=present
      sudo: yes

    - name: install docker-py
      command: python setup.py install chdir=/opt/docker-py
      sudo: yes

    ## Install LTFHC Docker sources and build images

    - name: Clone ltfhc-docker master repository
      git: repo=https://github.com/iilab/ltfhc-docker.git dest=/opt/ltfhc-docker
      sudo: yes

    - name: Build ltfhc-couch images
      docker_image: path="/opt/ltfhc-docker/ltfhc-couch" name="iilab/ltfhc-couch" state=build
      sudo: yes

    ## Remove ltfhc-couch if present

    - name: Remove ltfhc-couch
      docker: image="iilab/ltfhc-couch" name=couch ports=80:5984 state=absent
      sudo: yes

    #- name: Start ltfhc-couch
    #  docker: image="iilab/ltfhc-couch" name=couch ports=443:6984 state=running
    #  sudo: yes

    - name: Install ltfhc-couch as a system ctl service
      copy: src=system/ltfhc-couch.service dest=/etc/systemd/system/ltfhc-couch.service
      sudo: yes

    - name: Reload service file
      command: systemctl --system daemon-reload
      sudo: yes

    - name: Restart service
      service: name=ltfhc-couch.service enabled=yes state=restarted
      sudo: yes


